name: Rust CI

on:
  push:
    branches:
      - main
  pull_request:

# Cancel new runs for PRs only
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# Add default permissions for the workflow
permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:

  ############################
  #     General checks       #
  ############################
  check:
    runs-on: matterlabs-ci-runner-high-performance
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Setup runner
        uses: ./.github/actions/runner-setup
        with:
          save_cache: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

      - name: Check formatting
        run: cargo fmt --all --check

      # no-default-features is set because the code is a mix of GPU/non-GPU compliant code
      # the flag needs to be removed once we allow both version to be build and control it via env var
      # these changes will be removed once https://github.com/matter-labs/prover-subsystem-internal/issues/49 is done
      - name: Run Clippy
        run: cargo clippy --no-default-features -- -D warnings

      - name: Build server
        run: cargo build --release --no-default-features

      - name: Run tests
        run: cargo test --no-default-features


  ###############################
  #  Mandatory CI status check  #
  ###############################
  ci-success:
    name: Github Status Check
    runs-on: ubuntu-latest
    if: always() && !cancelled()
    needs:
      [
        check,
      ]
    steps:
      - name: Status
        run: |
          # This will check all jobs status in the `needs` list, and fail job if one is failed.
          # Since we split prover and core to different flows, this job will be only as Required Status Check in the Pull Request.
          if [[ ${{ contains(join(needs.*.result, ','), 'failure') }} == "true" ]]; then
            echo "Intentionally failing to block PR from merging"
            exit 1
          fi
